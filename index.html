<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Safe Custom YouTube Player</title>
<style>
  :root{--bg:#071023;--panel:#0e1622;--accent:#5ee3b4;--muted:#98a8bd}
  body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#031022 0%,#071827 100%);color:#e8f6ef;font-family:system-ui,Arial}
  .wrap{width:800px;max-width:95vw;border-radius:12px;overflow:hidden;box-shadow:0 12px 40px rgba(2,6,23,0.7)}
  .top{padding:12px;display:flex;gap:8px;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
  input[type=text]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.25);color:inherit;font-size:14px}
  button.primary{background:linear-gradient(180deg,var(--accent),#3ccda0);color:#052018;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .player-wrap{background:#000;aspect-ratio:16/9;position:relative}
  #player-iframe{position:absolute;inset:0}
  .controls{padding:12px;background:var(--panel);display:flex;flex-direction:column;gap:8px}
  .row{display:flex;align-items:center;gap:8px}
  .btn{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);color:var(--accent);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  input[type=range]{width:100%;height:6px;background:linear-gradient(90deg,var(--accent),#34c79e);border-radius:6px;-webkit-appearance:none}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:#fff;border-radius:50%;border:2px solid var(--panel);margin-top:-4px}
  .title{color:#dff7ea;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
  .small{color:var(--muted);font-size:13px}
  .disabled{opacity:0.5;pointer-events:none}
  @media (max-width:600px){.wrap{width:100%}.top{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
  <div class="wrap" role="region" aria-label="URLで再生するカスタムYouTubeプレイヤ">
    <div class="top">
      <input id="url-input" type="text" placeholder="YouTubeのURLを貼ってLoad（例: https://youtu.be/VIDEO_ID）" aria-label="YouTube URL"/>
      <button class="primary" id="load-btn">Load</button>
      <button class="btn" id="play-toggle" disabled>Play</button>
    </div>

    <div class="player-wrap" id="player-area" aria-live="polite">
      <div id="player-iframe"></div>
    </div>

    <div class="controls">
      <div class="row">
        <div class="title" id="video-title">No video loaded</div>
        <div class="small" id="state">Idle</div>
      </div>
      <div class="row">
        <input id="seek" type="range" min="0" max="100" step="0.1" value="0" aria-label="seek" disabled/>
        <div class="small" id="time">0:00 / 0:00</div>
      </div>
      <div class="row">
        <button class="btn" id="mute-btn" disabled>Mute</button>
        <input id="volume" type="range" min="0" max="100" step="1" value="100" style="width:160px" aria-label="volume" disabled/>
        <div style="flex:1"></div>
        <button class="btn" id="fs-btn">Fullscreen</button>
      </div>
    </div>
  </div>

<script>
/* --- URL から動画ID抽出 --- */
function extractVideoId(url){
  if(!url) return null;
  try{
    const u = new URL(url, location.href);
    if(u.hostname.endsWith('youtu.be')) return u.pathname.slice(1);
    if(u.searchParams && u.searchParams.get('v')) return u.searchParams.get('v');
    const parts = u.pathname.split('/');
    for(const p of parts){ if(/^[A-Za-z0-9_-]{11}$/.test(p)) return p; }
    return null;
  }catch(e){ return null; }
}

/* --- YouTube IFrame API 動的ロード --- */
(function loadYouTubeApi(){
  if(window.YT && YT.Player) return;
  const s = document.createElement('script');
  s.src = 'https://www.youtube.com/iframe_api';
  s.async = true;
  document.head.appendChild(s);
})();

/* --- DOM参照 --- */
const loadBtn = document.getElementById('load-btn');
const playBtn = document.getElementById('play-toggle');
const seekEl = document.getElementById('seek');
const timeEl = document.getElementById('time');
const volumeEl = document.getElementById('volume');
const muteBtn = document.getElementById('mute-btn');
const stateEl = document.getElementById('state');
const titleEl = document.getElementById('video-title');

let player = null;
let durationSec = 0;
let updatingSeek = false;
let progressTimer = null;

/* --- safe origin 作成 --- */
function getSafeOrigin(){
  // location.origin is fine; build explicitly to avoid odd hostnames
  return location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');
}

/* --- UI enable/disable --- */
function setUiReady(ready){
  playBtn.disabled = !ready;
  muteBtn.disabled = !ready;
  volumeEl.disabled = !ready;
  seekEl.disabled = !ready;
  if(ready) playBtn.classList.remove('disabled'); else playBtn.classList.add('disabled');
}

/* --- プレイヤ生成 / 破棄 --- */
function createPlayer(videoId){
  // 既存破棄（重複生成を防ぐ）
  if(player && player.destroy){
    try{ player.destroy(); }catch(e){ console.warn(e); }
    player = null;
    document.getElementById('player-iframe').innerHTML = '';
  }

  const origin = getSafeOrigin();

  player = new YT.Player('player-iframe', {
    width: '100%',
    height: '100%',
    videoId: videoId,
    playerVars: {
      enablejsapi: 1,
      controls: 0,
      modestbranding: 1,
      rel: 0,
      disablekb: 1,
      origin: origin
    },
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange,
      onError: onPlayerError
    }
  });

  setUiReady(false);
  titleEl.textContent = 'Loading...';
}

/* --- イベントハンドラ --- */
function onPlayerReady(e){
  setUiReady(true);
  try{ player.setVolume(Number(volumeEl.value)); }catch(e){}
  trySetDuration();
  startProgressTimer();
}

function onPlayerStateChange(e){
  const ps = YT.PlayerState;
  switch(e.data){
    case ps.PLAYING:
      playBtn.textContent = 'Pause';
      stateEl.textContent = 'Playing';
      break;
    case ps.PAUSED:
      playBtn.textContent = 'Play';
      stateEl.textContent = 'Paused';
      break;
    case ps.ENDED:
      playBtn.textContent = 'Replay';
      stateEl.textContent = 'Ended';
      break;
    case ps.BUFFERING:
      stateEl.textContent = 'Buffering';
      break;
    default:
      stateEl.textContent = 'Idle';
  }
  trySetDuration();
}

function onPlayerError(e){
  console.error('YouTube Player Error', e);
  alert('Player error code: ' + e.data);
  setUiReady(false);
}

/* --- duration 取得リトライ --- */
function trySetDuration(){
  if(!player || typeof player.getDuration !== 'function') return;
  const d = player.getDuration();
  if(d && d > 0){ durationSec = d; updateTimeLabel(); }
  else setTimeout(trySetDuration, 500);
}

/* --- UI イベント --- */
loadBtn.addEventListener('click', () => {
  const id = extractVideoId(document.getElementById('url-input').value.trim());
  if(!id){ alert('YouTubeのURLを正しく入力してください'); return; }

  // API 読み込み完了を待って一度だけ createPlayer を呼ぶ
  if(window.YT && typeof YT.Player === 'function'){
    createPlayer(id);
    titleEl.textContent = 'Video ID: ' + id;
  } else {
    // onYouTubeIframeAPIReady を使って待つ
    window._ytPendingLoad = id;
  }
});

playBtn.addEventListener('click', () => {
  if(!player || typeof player.getPlayerState !== 'function'){ console.warn('player not ready'); return; }
  const s = player.getPlayerState();
  if(s === YT.PlayerState.PLAYING) player.pauseVideo();
  else if(s === YT.PlayerState.ENDED){ player.seekTo(0,true); player.playVideo(); }
  else player.playVideo();
});

seekEl.addEventListener('input', (e) => {
  updatingSeek = true;
  const pct = Number(e.target.value);
  const sec = (pct/100) * (durationSec || 0);
  updateTimeLabel(sec);
});
seekEl.addEventListener('change', (e) => {
  const pct = Number(e.target.value);
  const sec = (pct/100) * (durationSec || 0);
  if(player && typeof player.seekTo === 'function') player.seekTo(sec, true);
  updatingSeek = false;
});

volumeEl.addEventListener('input', (e) => {
  if(player && typeof player.setVolume === 'function') player.setVolume(Number(e.target.value));
});

muteBtn.addEventListener('click', () => {
  if(!player) return;
  if(player.isMuted && player.isMuted()){
    player.unMute();
    muteBtn.textContent = 'Mute';
    volumeEl.value = player.getVolume ? player.getVolume() : 100;
  } else {
    player.mute();
    muteBtn.textContent = 'Unmute';
    volumeEl.value = 0;
  }
});

document.getElementById('fs-btn').addEventListener('click', async () => {
  const wrap = document.querySelector('.wrap');
  try{
    if(!document.fullscreenElement) await wrap.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){ console.warn(e); }
});

/* --- 進捗タイマー --- */
function startProgressTimer(){
  if(progressTimer) return;
  progressTimer = setInterval(() => {
    if(!player || typeof player.getCurrentTime !== 'function') return;
    const cur = player.getCurrentTime();
    if(!updatingSeek && durationSec > 0){
      const pct = (cur/durationSec) * 100;
      seekEl.value = String(pct);
      updateTimeLabel(cur);
    } else {
      updateTimeLabel(cur);
    }
  }, 250);
}

/* --- 時間表示 --- */
function updateTimeLabel(curSec){
  const cur = (typeof curSec === 'number') ? curSec : (player && player.getCurrentTime ? player.getCurrentTime() : 0);
  const dur = durationSec || (player && player.getDuration ? player.getDuration() : 0);
  timeEl.textContent = formatTime(cur) + ' / ' + formatTime(dur);
}
function formatTime(sec){
  if(!isFinite(sec) || sec <= 0) return '0:00';
  const s = Math.floor(sec % 60).toString().padStart(2,'0');
  const m = Math.floor(sec/60).toString();
  return m + ':' + s;
}

/* --- onYouTubeIframeAPIReady を確実に処理 --- */
function onYouTubeIframeAPIReady(){
  // ページ内に保留されたロード要求があれば処理
  if(window._ytPendingLoad){
    const id = window._ytPendingLoad;
    window._ytPendingLoad = null;
    createPlayer(id);
    titleEl.textContent = 'Video ID: ' + id;
  }
}
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

/* --- クリーンアップ --- */
window.addEventListener('beforeunload', () => {
  try{ if(player && player.destroy) player.destroy(); }catch(e){}
});
</script>
</body>
</html>

