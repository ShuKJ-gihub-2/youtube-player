<!-- YouTube URL 入力（上部に置く） -->
<style>
  #ry_url_wrap{display:flex;gap:8px;align-items:center;margin:12px 0}
  #ry_url{flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071022;color:#fff}
  #ry_url_btn{padding:8px 12px;border-radius:6px;border:0;background:#ff4d4d;color:#fff;cursor:pointer}
</style>

<div id="ry_url_wrap" aria-label="YouTube URL input">
  <input id="ry_url" placeholder="YouTube の URL を貼って Enter または 再生 ボタン" />
  <button id="ry_url_btn">再生</button>
</div>

<script>
(function(){
  const input = document.getElementById('ry_url');
  const btn = document.getElementById('ry_url_btn');

  function parseYouTubeId(url){
    if(!url) return null;
    url = url.trim();
    if(/^[A-Za-z0-9_-]{11}$/.test(url)) return url;
    try{
      if(!/^https?:\/\//i.test(url)) url = 'https://'+url;
      const u = new URL(url);
      if(u.hostname === 'youtu.be') return u.pathname.slice(1);
      if(u.hostname.endsWith('youtube.com') || u.hostname.endsWith('youtube-nocookie.com')){
        const emb = u.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/);
        if(emb) return emb[1];
        const v = u.searchParams.get('v');
        if(v && /^[A-Za-z0-9_-]{11}$/.test(v)) return v;
        const p = u.pathname.match(/\/v\/([A-Za-z0-9_-]{11})/);
        if(p) return p[1];
      }
    }catch(e){}
    const m = url.match(/([A-Za-z0-9_-]{11})/);
    return m ? m[1] : null;
  }

  function ensureYouTubeApiLoaded(){
    return new Promise((resolve) => {
      if(window.YT && window.YT.Player) return resolve();
      // queue callbacks instead of overwriting
      const cbName = '__ry_on_youtube_ready__';
      if(window[cbName]) {
        // someone else already created queue; push resolver
        window[cbName]._q = window[cbName]._q || [];
        window[cbName]._q.push(resolve);
        return;
      }
      // create queue function
      window[cbName] = function(){
        (window[cbName]._q || []).forEach(fn => { try{ fn(); }catch(e){} });
        try{ resolve(); }catch(e){}
      };
      window[cbName]._q = [resolve];
      // install adapter that calls our queue when API ready
      const prev = window.onYouTubeIframeAPIReady;
      window.onYouTubeIframeAPIReady = function(){
        if(typeof prev === 'function') try{ prev(); }catch(e){}
        try{ window[cbName](); }catch(e){}
      };
      // inject API script if not present
      if(!document.getElementById('ry-yt-api')){
        const s = document.createElement('script');
        s.id = 'ry-yt-api';
        s.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(s);
      }
    });
  }

  async function playId(id){
    if(!id) { alert('YouTube ID を解析できませんでした'); return; }

    // 1) If the site integration exposed a player, use it
    if(window.__RY_PLAYER && window.__RY_PLAYER.player){
      const p = window.__RY_PLAYER.player;
      try{ if(typeof p.loadVideoById === 'function'){ p.loadVideoById(id); return; } }catch(e){}
    }

    // 2) If a global created instance exists, use it (compat)
    if(window.__RY_PLAYER && window.__RY_PLAYER.loadIndex){
      try{ window.__RY_PLAYER.loadIndex(0); }catch(e){} // best-effort; skip
    }

    // 3) Otherwise create (or reuse) a temporary YT player in #player
    const container = document.getElementById('player') || document.body;
    let holder = document.getElementById('ry_yt_holder');
    if(!holder){
      holder = document.createElement('div');
      holder.id = 'ry_yt_holder';
      holder.style.width = '100%';
      holder.style.height = '100%';
      // insert at top of player container so UI overlays still work
      container.insertBefore(holder, container.firstChild);
    } else {
      holder.innerHTML = '';
    }

    await ensureYouTubeApiLoaded();
    // if an existing created instance is present, prefer updating it
    if(window.__RY_TEMP_PLAYER && window.__RY_TEMP_PLAYER.loadVideoById){
      try{ window.__RY_TEMP_PLAYER.loadVideoById(id); return; }catch(e){}
    }
    // create new player
    window.__RY_TEMP_PLAYER = new YT.Player('ry_yt_holder', {
      width: '100%', height: '100%', videoId: id,
      playerVars: { controls: 1, rel: 1, modestbranding: 0, enablejsapi:1, origin: location.origin }
    });
  }

  function handlePlay(){
    const id = parseYouTubeId(input.value || '');
    if(!id){ alert('URL を確認してください'); return; }
    playId(id);
  }

  btn.addEventListener('click', handlePlay);
  input.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); handlePlay(); } });

  // prefill from ?v= if present
  (function prefill(){
    try{ const p = new URL(location.href).searchParams.get('v'); if(p) input.value = 'https://www.youtube.com/watch?v=' + p; }catch(e){}
  })();
})();
</script>
