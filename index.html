<!-- YouTube URL 入力（上部に置く） -->
<style>
  #ry_url_wrap{display:flex;gap:8px;align-items:center;margin:12px 0}
  #ry_url{flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071022;color:#fff}
  #ry_url_btn{padding:8px 12px;border-radius:6px;border:0;background:#ff4d4d;color:#fff;cursor:pointer}
</style>

<div id="ry_url_wrap" aria-label="YouTube URL input">
  <input id="ry_url" placeholder="YouTube の URL を貼って Enter または 再生 ボタン" />
  <button id="ry_url_btn">再生</button>
</div>

<script>
(function(){
  const input = document.getElementById('ry_url');
  const btn = document.getElementById('ry_url_btn');

  function parseYouTubeId(url){
    if(!url) return null;
    url = url.trim();
    // plain id
    if(/^[A-Za-z0-9_-]{11}$/.test(url)) return url;
    try{
      // add protocol if missing
      if(!/^https?:\/\//i.test(url)) url = 'https://'+url;
      const u = new URL(url);
      // youtu.be short
      if(u.hostname === 'youtu.be') return u.pathname.slice(1);
      // youtube.com domain
      if(u.hostname.endsWith('youtube.com') || u.hostname.endsWith('youtube-nocookie.com')){
        // /embed/ID
        const emb = u.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/);
        if(emb) return emb[1];
        // v= or list/watch?v=
        const v = u.searchParams.get('v');
        if(v && /^[A-Za-z0-9_-]{11}$/.test(v)) return v;
        // /v/ID format
        const p = u.pathname.match(/\/v\/([A-Za-z0-9_-]{11})/);
        if(p) return p[1];
      }
    }catch(e){}
    // fallback: try to find 11-char id in string
    const m = url.match(/([A-Za-z0-9_-]{11})/);
    return m ? m[1] : null;
  }

  async function playId(id){
    if(!id) { alert('YouTube ID を解析できませんでした'); return; }
    // Prefer existing ry player if exposed
    if(window.__RY_PLAYER && window.__RY_PLAYER.player){
      const p = window.__RY_PLAYER.player;
      try{
        if(typeof p.loadVideoById === 'function'){
          p.loadVideoById(id);
          // ensure overlay hidden
          window.__RY_PLAYER.hideEndOverlay?.();
          return;
        }
      }catch(e){}
    }
    // Otherwise, try to use global YT Player created by our earlier script
    if(window.YT && window.YT.Player && window.ry_player_created){
      try{
        const p = window.ry_player_created;
        if(p && typeof p.loadVideoById === 'function'){ p.loadVideoById(id); return; }
      }catch(e){}
    }
    // If no player exists, set ?v= and reload to let the integration pick it up,
    // or create a minimal iframe player here.
    // Try to create minimal iframe API player in #player if present
    const container = document.getElementById('player');
    if(container){
      // remove existing placeholder holder if any
      let holder = document.getElementById('ry_yt_holder');
      if(!holder){
        holder = document.createElement('div'); holder.id = 'ry_yt_holder';
        container.insertBefore(holder, container.firstChild);
      } else { holder.innerHTML = ''; }
      // ensure YT API loaded
      if(!window.YT || !window.YT.Player){
        // load API once
        if(!document.getElementById('ry-yt-api')) {
          const s = document.createElement('script');
          s.id = 'ry-yt-api'; s.src = 'https://www.youtube.com/iframe_api';
          document.head.appendChild(s);
        }
        // wait for API ready
        window.onYouTubeIframeAPIReady = function(){
          createTempPlayer(id);
        };
      } else {
        createTempPlayer(id);
      }
      return;
    }
    // fallback: set URL param and reload
    const u = new URL(location.href);
    u.searchParams.set('v', id);
    location.href = u.toString();
  }

  function createTempPlayer(id){
    try{
      // guard: if ry integration already created, don't stomp it
      if(window.__RY_PLAYER && window.__RY_PLAYER.player) {
        window.__RY_PLAYER.player.loadVideoById(id);
        return;
      }
      const holder = document.getElementById('ry_yt_holder') || (function(){
        const c = document.getElementById('player') || document.body;
        const d = document.createElement('div'); d.id = 'ry_yt_holder'; c.insertBefore(d, c.firstChild); return d;
      })();
      // store created instance globally
      window.ry_player_created = new YT.Player('ry_yt_holder', {
        width:'100%', height:'100%', videoId: id,
        playerVars: { controls:1, rel:1, modestbranding:0, enablejsapi:1, origin: location.origin }
      });
    }catch(e){ console.warn(e); }
  }

  function handlePlay(){
    const id = parseYouTubeId(input.value || '');
    if(id) playId(id);
    else alert('URL を確認してください');
  }

  btn.addEventListener('click', handlePlay);
  input.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); handlePlay(); } });

  // optional: if page URL has ?v=VIDEO, prefill input
  (function prefill(){
    try{
      const p = new URL(location.href).searchParams.get('v');
      if(p){ input.value = 'https://www.youtube.com/watch?v=' + p; }
    }catch(e){}
  })();
})();
</script>
